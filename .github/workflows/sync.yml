name: CloudStream Single File

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '*/30 * * * *' # æ¯30åˆ†é’Ÿè¿è¡Œ

jobs:
  sync_service:
    runs-on: ubuntu-latest
    timeout-minutes: 360 

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Setup Env
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install Tools
      run: |
        pip install psycopg2-binary huggingface_hub requests
        # åªå®‰è£… aria2ï¼Œä¸éœ€è¦ ffmpeg
        sudo apt-get update && sudo apt-get install -y aria2

    - name: Process Stream
      id: transfer
      env:
        DB_CONNECT: ${{ secrets.DB_CONNECT }}
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
        HF_REPO_ID: ${{ secrets.HF_REPO_ID }}
      run: |
        python <<EOF
        import os
        import psycopg2
        import subprocess
        from huggingface_hub import HfApi
        from urllib.parse import unquote

        # === éšè”½é…ç½® ===
        TABLE = "sys_logs"
        COL_URL = "payload"
        COL_STATUS = "level"
        COL_FOLDER = "folder"
        ST_PENDING = "info"
        ST_PROCESS = "warn"
        ST_DONE = "debug"
        # ==========

        db_url = os.environ.get("DB_CONNECT")
        hf_token = os.environ.get("HF_TOKEN")
        repo_id = os.environ.get("HF_REPO_ID")

        print("ğŸš€ System Diagnostics Started...")
        try:
            conn = psycopg2.connect(db_url)
            cur = conn.cursor()

            # 1. æŸ¥æ‰¾ä»»åŠ¡
            cur.execute(f'SELECT id, {COL_URL}, {COL_FOLDER} FROM "{TABLE}" WHERE "{COL_STATUS}" = %s LIMIT 1', (ST_PENDING,))
            row = cur.fetchone()
            
            if row:
                task_id, file_url, folder_name = row
                
                # å¤„ç†æ–‡ä»¶å¤¹å
                if not folder_name or folder_name.strip() == "": folder_name = "Downloads"
                folder_name = folder_name.strip().replace("..", "").strip("/")

                print(f"âœ… [Task] ID: {task_id} | ç›®æ ‡æ–‡ä»¶å¤¹: {folder_name}")
                
                # 2. æ ‡è®°è¿›è¡Œä¸­
                cur.execute(f'UPDATE "{TABLE}" SET "{COL_STATUS}" = %s WHERE id = %s', (ST_PROCESS, task_id))
                conn.commit()
                
                # æå–æ–‡ä»¶å
                try:
                    filename = unquote(file_url.split('/')[-1].split('?')[0])
                    if not filename or len(filename) > 200: filename = f"file_{task_id}.bin"
                except:
                    filename = f"file_{task_id}.bin"
                
                print(f"â¬‡ï¸ [Downloading] {filename}")

                # 3. Aria2 ä¸‹è½½ (ä¼ªè£… UA)
                user_agent = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
                cmd = [
                    "aria2c", "-x", "16", "-s", "16", "-k", "1M",
                    "--user-agent", user_agent, "-o", filename, file_url
                ]
                
                result = subprocess.run(cmd)
                
                if result.returncode == 0 and os.path.exists(filename):
                    f_size = os.path.getsize(filename)
                    print(f"ğŸ“¦ æ–‡ä»¶å¤§å°: {f_size / 1024 / 1024:.2f} MB")

                    # âš ï¸ 14GB é™åˆ¶æ£€æŸ¥
                    # GitHub Runner åªæœ‰çº¦ 14GB å¯ç”¨ç©ºé—´ã€‚
                    # å¦‚æœä¸‹è½½äº† 10GBï¼Œå†å¤„ç†ä¸€ä¸‹å¾ˆå®¹æ˜“çˆ†ã€‚å•æ–‡ä»¶ç›´ä¼ ç›¸å¯¹å®‰å…¨ï¼Œä½†å°½é‡åˆ«è¶… 12GBã€‚
                    if f_size > 13 * 1024 * 1024 * 1024:
                         print("âŒ [Error] æ–‡ä»¶è¿‡å¤§ (>13GB)ï¼ŒGitHub ç©ºé—´ä¸è¶³ï¼")
                         cur.execute(f'UPDATE "{TABLE}" SET "{COL_STATUS}" = %s WHERE id = %s', ('fatal', task_id))
                         conn.commit()
                         exit(1)

                    # 4. ä¸Šä¼ åˆ° Hugging Face
                    # è·¯å¾„æ ¼å¼: æ–‡ä»¶å¤¹/æ–‡ä»¶å
                    target_path = f"{folder_name}/{filename}"
                    print(f"â¬†ï¸ [Uploading] {target_path}")
                    
                    api = HfApi(token=hf_token)
                    try:
                        api.upload_file(
                            path_or_fileobj=filename,
                            path_in_repo=target_path,
                            repo_id=repo_id,
                            repo_type="dataset"
                        )
                        print("ğŸ‰ [Success] ä¸Šä¼ å®Œæˆï¼")
                        
                        # 5. æ ‡è®°å®Œæˆ
                        cur.execute(f'UPDATE "{TABLE}" SET "{COL_STATUS}" = %s WHERE id = %s', (ST_DONE, task_id))
                        conn.commit()
                        os.remove(filename)
                        
                        # å†™å…¥ç¯å¢ƒå˜é‡ä¾›é‚®ä»¶ä½¿ç”¨
                        with open(os.environ['GITHUB_ENV'], 'a') as f:
                            f.write(f"SYNC_FILENAME={filename}\n")
                            f.write(f"SYNC_FOLDER={folder_name}\n")
                            # ç”Ÿæˆ Cloudflare åŠ é€Ÿæ’­æ”¾é“¾æ¥ (å‡è®¾ä½ å·²ç»éƒ¨ç½²äº† CF Worker)
                            # å¦‚æœæ²¡éƒ¨ç½² Workerï¼Œè¿™é‡Œåªæ˜¯ä¸ªç¤ºä¾‹é“¾æ¥
                            web_url = f"https://huggingface.co/datasets/{repo_id}/blob/main/{target_path}"
                            f.write(f"WEB_URL={web_url}\n")

                    except Exception as e:
                        print(f"âŒ [Upload Error] {e}")
                        cur.execute(f'UPDATE "{TABLE}" SET "{COL_STATUS}" = %s WHERE id = %s', ('fatal', task_id))
                        conn.commit()
                        exit(1)
                else:
                    print("âŒ [Download Failed] ä¸‹è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥é“¾æ¥æœ‰æ•ˆæ€§ã€‚")
                    cur.execute(f'UPDATE "{TABLE}" SET "{COL_STATUS}" = %s WHERE id = %s', ('fatal', task_id))
                    conn.commit()
                    exit(1)
            else:
                print("ğŸ’¤ [Idle] æš‚æ— ä»»åŠ¡")
            
            cur.close()
            conn.close()

        except Exception as e:
            print(f"âŒ [Kernel Error] {e}")
            exit(1)
        EOF

    # é‚®ä»¶é€šçŸ¥
    - name: Notify Success
      if: success() && env.SYNC_FILENAME != ''
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.qq.com
        server_port: 465
        username: ${{ secrets.MAIL_USERNAME }}
        password: ${{ secrets.MAIL_PASSWORD }}
        subject: âœ… [å½’æ¡£å®Œæˆ] ${{ env.SYNC_FILENAME }}
        body: |
          æ–‡ä»¶å·²å­˜å…¥ Hugging Face (å•æ–‡ä»¶æ¨¡å¼)ã€‚
          
          ğŸ“‚ ç›®å½•: ${{ env.SYNC_FOLDER }}
          ğŸ“„ æ–‡ä»¶: ${{ env.SYNC_FILENAME }}
          
          ğŸŒ æŸ¥çœ‹åœ°å€:
          ${{ env.WEB_URL }}
        to: ${{ secrets.MAIL_USERNAME }}
        from: CloudStream Bot
        secure: true
