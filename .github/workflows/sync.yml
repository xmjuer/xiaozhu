name: CloudStream Transfer

on:
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨ç‚¹å‡»è¿è¡Œ
  schedule:
    - cron: '*/30 * * * *' # æ¯30åˆ†é’Ÿè‡ªåŠ¨è¿è¡Œä¸€æ¬¡

jobs:
  sync_service:
    runs-on: ubuntu-latest
    # è®¾ç½®æœ€å¤§è¶…æ—¶æ—¶é—´ï¼Œæ¥è¿‘ GitHub å…è´¹ç‰ˆæé™ (6å°æ—¶)
    timeout-minutes: 355 

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Python environment
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install System Dependencies
      run: |
        # æ›´æ–°æºå¹¶å®‰è£… FFmpeg (ç”¨äºåˆ‡ç‰‡) å’Œ Aria2 (ç”¨äºå¤‡ç”¨)
        sudo apt-get update
        sudo apt-get install -y ffmpeg aria2

    - name: Install Python Dependencies
      run: |
        pip install psycopg2-binary huggingface_hub requests

    - name: Run Stream Processing Script
      id: transfer
      env:
        # ä» GitHub Secrets è¯»å–æ•æ„Ÿä¿¡æ¯
        DB_CONNECT: ${{ secrets.DB_CONNECT }}
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
        HF_REPO_ID: ${{ secrets.HF_REPO_ID }}
      run: |
        python <<EOF
        import os
        import psycopg2
        import subprocess
        import shutil
        import time
        import threading
        from huggingface_hub import HfApi
        from urllib.parse import unquote

        # === é…ç½®åŒºåŸŸ ===
        TABLE = "sys_logs"      # æ•°æ®åº“è¡¨å
        COL_URL = "payload"     # é“¾æ¥å­—æ®µ
        COL_STATUS = "level"    # çŠ¶æ€å­—æ®µ
        COL_FOLDER = "folder"   # æ–‡ä»¶å¤¹å­—æ®µ
        ST_PENDING = "info"     # å¾…å¤„ç†çŠ¶æ€
        ST_PROCESS = "warn"     # è¿›è¡Œä¸­çŠ¶æ€
        ST_DONE = "debug"       # å®ŒæˆçŠ¶æ€
        # ================

        # è·å–ç¯å¢ƒå˜é‡
        db_url = os.environ.get("DB_CONNECT")
        hf_token = os.environ.get("HF_TOKEN")
        repo_id = os.environ.get("HF_REPO_ID")
        api = HfApi(token=hf_token)

        # å…¨å±€å˜é‡æ§åˆ¶çº¿ç¨‹
        slice_dir = ""
        target_hf_path = ""
        is_ffmpeg_running = False
        uploaded_files = set()

        # === ç›‘æ§å¹¶ä¸Šä¼ çº¿ç¨‹ (è¾¹åˆ‡è¾¹ä¼ æ ¸å¿ƒé€»è¾‘) ===
        def upload_monitor():
            print("ğŸ‘€ [Monitor] ä¸Šä¼ ç›‘æ§çº¿ç¨‹å·²å¯åŠ¨...")
            while is_ffmpeg_running or (os.path.exists(slice_dir) and len(os.listdir(slice_dir)) > 0):
                try:
                    if not os.path.exists(slice_dir): break
                    # è·å–ç›®å½•ä¸‹æ‰€æœ‰ç›¸å…³æ–‡ä»¶
                    files = sorted([f for f in os.listdir(slice_dir) if f.endswith('.ts') or f.endswith('.m3u8')])
                except:
                    break
                
                for f in files:
                    local_path = os.path.join(slice_dir, f)
                    
                    # é€»è¾‘ï¼šå¦‚æœæ˜¯ .ts åˆ‡ç‰‡ï¼Œä¸”ä¸æ˜¯æœ€æ–°çš„ä¸€ä¸ªï¼ˆé˜²æ­¢ä¸Šä¼ æ­£åœ¨å†™å…¥çš„æ–‡ä»¶ï¼‰
                    # æˆ–è€… FFmpeg å·²ç»ç»“æŸï¼ˆè¯´æ˜æ‰€æœ‰æ–‡ä»¶éƒ½å†™å®Œäº†ï¼‰
                    should_upload = False
                    if f.endswith('.ts'):
                        if not is_ffmpeg_running: should_upload = True # å®Œå·¥äº†ï¼Œå…¨éƒ¨ä¸Šä¼ 
                        elif f != files[-1]: should_upload = True      # ä¸æ˜¯æœ€åä¸€ä¸ªï¼Œä¸Šä¼ 
                    elif f.endswith('.m3u8') and not is_ffmpeg_running:
                        should_upload = True # ç´¢å¼•æ–‡ä»¶æœ€åä¸Šä¼ 

                    if should_upload:
                        if f not in uploaded_files:
                            try:
                                # ä¸Šä¼ åˆ° Hugging Face
                                api.upload_file(
                                    path_or_fileobj=local_path,
                                    path_in_repo=f"{target_hf_path}/{f}",
                                    repo_id=repo_id,
                                    repo_type="dataset"
                                )
                                uploaded_files.add(f)
                                # ä¸Šä¼ æˆåŠŸåç«‹å³åˆ é™¤æœ¬åœ°æ–‡ä»¶ï¼ŒèŠ‚çœç©ºé—´
                                os.remove(local_path)
                            except Exception as e:
                                print(f"âš ï¸ [Upload Error] {f}: {e}")
                
                time.sleep(2) # ä¼‘æ¯2ç§’ç»§ç»­è½®è¯¢

        print("ğŸš€ [System] å¼€å§‹æ£€æŸ¥ä»»åŠ¡é˜Ÿåˆ—...")
        try:
            conn = psycopg2.connect(db_url)
            cur = conn.cursor()

            # 1. ä»æ•°æ®åº“è·å–ä»»åŠ¡
            cur.execute(f'SELECT id, {COL_URL}, {COL_FOLDER} FROM "{TABLE}" WHERE "{COL_STATUS}" = %s LIMIT 1', (ST_PENDING,))
            row = cur.fetchone()
            
            if row:
                task_id, file_url, folder_name = row
                
                # æ–‡ä»¶å¤¹åç§°å¤„ç†
                if not folder_name or folder_name.strip() == "": folder_name = "Downloads"
                folder_name = folder_name.strip().replace("..", "").strip("/")

                print(f"âœ… [Task Found] ID: {task_id} | ç›®æ ‡æ–‡ä»¶å¤¹: {folder_name}")
                
                # æ›´æ–°æ•°æ®åº“çŠ¶æ€ä¸º 'è¿›è¡Œä¸­'
                cur.execute(f'UPDATE "{TABLE}" SET "{COL_STATUS}" = %s WHERE id = %s', (ST_PROCESS, task_id))
                conn.commit()
                
                # è§£ææ–‡ä»¶å
                try:
                    raw_filename = unquote(file_url.split('/')[-1].split('?')[0])
                    base_name = os.path.splitext(raw_filename)[0]
                    # é˜²æ­¢æ–‡ä»¶åè¿‡é•¿
                    if len(base_name) > 100: base_name = f"video_{task_id}"
                except:
                    base_name = f"video_{task_id}"
                
                # è®¾ç½®æœ¬åœ°å’Œäº‘ç«¯è·¯å¾„
                slice_dir = f"slice_{task_id}"
                target_hf_path = f"{folder_name}/{base_name}"
                
                # æ¸…ç†æ—§ç›®å½•
                if os.path.exists(slice_dir): shutil.rmtree(slice_dir)
                os.makedirs(slice_dir)
                
                print(f"ğŸ¬ [Processing] æ­£åœ¨å¤„ç†: {base_name}")
                print("âš ï¸ æ¨¡å¼: HLS æµå¼åˆ‡ç‰‡ä¸Šä¼  (æ”¯æŒè¶…å¤§æ–‡ä»¶)")

                m3u8_file = os.path.join(slice_dir, "index.m3u8")
                ts_format = os.path.join(slice_dir, "%04d.ts")
                
                # ä¼ªè£… User-Agent
                user_agent = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
                
                # FFmpeg å‘½ä»¤
                cmd = [
                    "ffmpeg", 
                    "-user_agent", user_agent,
                    "-headers", f"User-Agent: {user_agent}",
                    "-i", file_url,
                    "-c", "copy",             # ç›´æ¥å¤åˆ¶æµï¼Œä¸è½¬ç 
                    "-hls_time", "5",         # 5ç§’ä¸€åˆ‡ç‰‡
                    "-hls_playlist_type", "vod",
                    "-hls_segment_filename", ts_format,
                    "-hls_list_size", "0",
                    "-f", "hls",
                    m3u8_file
                ]
                
                # å¼€å¯åŒçº¿ç¨‹
                is_ffmpeg_running = True
                uploader = threading.Thread(target=upload_monitor)
                uploader.start()
                
                # é˜»å¡è¿è¡Œ FFmpeg (åªæ˜¾ç¤ºé”™è¯¯æ—¥å¿—)
                result = subprocess.run(cmd, stdout=subprocess.DEVNULL, stderr=subprocess.PIPE)
                
                # FFmpeg ç»“æŸ
                is_ffmpeg_running = False
                uploader.join() # ç­‰å¾…ä¸Šä¼ çº¿ç¨‹æ”¶å°¾
                
                if result.returncode == 0:
                    print("ğŸ‰ [Success] æ‰€æœ‰åˆ‡ç‰‡ä¸Šä¼ å®Œæ¯•!")
                    
                    # æ ‡è®°æ•°æ®åº“ä¸º 'å®Œæˆ'
                    cur.execute(f'UPDATE "{TABLE}" SET "{COL_STATUS}" = %s WHERE id = %s', (ST_DONE, task_id))
                    conn.commit()
                    
                    # å†™å…¥ GitHub Env ä¾›é‚®ä»¶ä½¿ç”¨
                    with open(os.environ['GITHUB_ENV'], 'a') as f:
                        f.write(f"SYNC_FILENAME={base_name}\n")
                        f.write(f"SYNC_FOLDER={folder_name}\n")
                        # æ„é€ åœ¨çº¿æ’­æ”¾åœ°å€
                        play_url = f"https://huggingface.co/datasets/{repo_id}/resolve/main/{target_hf_path}/index.m3u8"
                        f.write(f"PLAY_URL={play_url}\n")
                        
                    # æ¸…ç†æ®‹ä½™
                    if os.path.exists(slice_dir): shutil.rmtree(slice_dir)

                else:
                    err_log = result.stderr.decode('utf-8')[-500:]
                    print(f"âŒ [Error] FFmpeg å¤±è´¥: {err_log}")
                    cur.execute(f'UPDATE "{TABLE}" SET "{COL_STATUS}" = %s WHERE id = %s', ('fatal', task_id))
                    conn.commit()
                    if os.path.exists(slice_dir): shutil.rmtree(slice_dir)
                    exit(1) # é€€å‡ºä»¥è§¦å‘å¤±è´¥é€šçŸ¥
            else:
                print("ğŸ’¤ [Idle] æš‚æ— å¾…å¤„ç†ä»»åŠ¡")
            
            cur.close()
            conn.close()

        except Exception as e:
            print(f"âŒ [Kernel Error] è„šæœ¬å†…éƒ¨é”™è¯¯: {e}")
            exit(1)
        EOF

    # é‚®ä»¶é€šçŸ¥ (æˆåŠŸ)
    - name: Notify Success
      if: success() && env.SYNC_FILENAME != ''
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.qq.com
        server_port: 465
        username: ${{ secrets.MAIL_USERNAME }}
        password: ${{ secrets.MAIL_PASSWORD }}
        subject: ğŸ¬ [å®Œæˆ] ${{ env.SYNC_FILENAME }}
        body: |
          æ–‡ä»¶å½’æ¡£æˆåŠŸ (HLSåˆ‡ç‰‡)ã€‚
          
          ğŸ“‚ ç›®å½•: ${{ env.SYNC_FOLDER }}
          ğŸ“¦ åç§°: ${{ env.SYNC_FILENAME }}
          
          â–¶ï¸ æ’­æ”¾é“¾æ¥ (å¤åˆ¶åˆ° PotPlayer/VLC):
          ${{ env.PLAY_URL }}
        to: ${{ secrets.MAIL_USERNAME }}
        from: CloudStream Bot
        secure: true

    # é‚®ä»¶é€šçŸ¥ (å¤±è´¥)
    - name: Notify Failure
      if: failure()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.qq.com
        server_port: 465
        username: ${{ secrets.MAIL_USERNAME }}
        password: ${{ secrets.MAIL_PASSWORD }}
        subject: âŒ [å¤±è´¥] è½¬å­˜ä»»åŠ¡å‡ºé”™
        body: |
          GitHub Actions æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ã€‚
          è¯·æ£€æŸ¥æºé“¾æ¥æ˜¯å¦æœ‰æ•ˆï¼Œæˆ–æŸ¥çœ‹ GitHub æ—¥å¿—ã€‚
        to: ${{ secrets.MAIL_USERNAME }}
        from: CloudStream Bot
        secure: true
